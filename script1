#!/bin/sh

# Set groups for new user
NEW_USER_GROUPS="adm,dialout,cdrom,sudo,audio,video,plugdev,games,users,input,netdev,gpio,i2c,spi"

# create new user
printf "Type in new username, followed by [ENTER]:"
read username

#printf "Create user $username..."
sudo useradd $username -G $NEW_USER_GROUPS -m
printf "\e[1m\e[32mDONE\e[39m\e[21m\n"

sudo passwd nbonniot

# Copy all pi user home files to set it to new user
sudo cp -R ~/* /home/$username/
sudo cp -R ~/.* /home/$username/

sudo chown -R $username:$username /home/$username

# Get raspi-config
printf "Create raspi-config...\n"
rm -rf /tmp/raspi-config
mkdir /tmp/raspi-config
git clone https://github.com/devgiants/raspi-config.git /tmp/raspi-config

# Extend root FS
sudo /tmp/raspi-config/raspi-config --expand-rootfs

# Rename hostname
printf "Type in new hostname, followed by [ENTER]:"
read NEW_HOSTNAME
sudo /tmp/raspi-config/raspi-config --change-hostname=$NEW_HOSTNAME

printf "Activate SSH server\n"
sudo /tmp/raspi-config/raspi-config --ssh=1
printf "\e[1m\e[32mDONE\e[39m\e[21m\n"

printf "Change SSH port and allow only $username connections\n"
sudo sed -i 's/Port 22/Port 6061\nAllowUsers nbonniot/g' /etc/ssh/sshd_config
printf "\e[1m\e[32mDONE\e[39m\e[21m\n"

printf "Activate I2C on startup\n"
sudo /tmp/raspi-config/raspi-config --i2c=1
printf "\e[1m\e[32mDONE\e[39m\e[21m\n"

printf "Activate SPI on startup\n"
sudo /tmp/raspi-config/raspi-config --spi=1
printf "\e[1m\e[32mDONE\e[39m\e[21m\n"


sudo reboot
